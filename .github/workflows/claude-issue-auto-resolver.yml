name: Claude Issue Auto-resolver

on:
  schedule:
    # JST 1:00~7:00 = UTC 16:00~22:00 (every hour)
    - cron: '0 16,17,18,19,20,21,22 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  resolve-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Find and comment on unresolved issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            // Search for issues in priority order: high -> medium -> low
            const priorities = ['priority:high', 'priority:medium', 'priority:low'];

            for (const priority of priorities) {
              console.log(`Searching for issues with label: ${priority}`);

              // Get all open issues with the priority label
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: priority,
                state: 'open',
                sort: 'created',
                direction: 'desc'
              });

              // Find unresolved issues (without claude-code-requested label)
              const unresolvedIssue = issues.find(issue =>
                !issue.labels.some(label => label.name === 'claude-code-requested')
              );

              if (unresolvedIssue) {
                console.log(`Found issue #${unresolvedIssue.number} with ${priority}`);

                // Analyze issue content to determine type
                const issueContent = `${unresolvedIssue.title} ${unresolvedIssue.body || ''}`.toLowerCase();

                let issueType = 'type:feature'; // default
                let requestMessage = '@claude この機能の実装方針をまとめて、実装PRを作ってください';

                if (issueContent.match(/bug|バグ|エラー|error|不具合|修正|fix|問題/)) {
                  issueType = 'type:bug';
                  requestMessage = '@claude このバグを調査して、修正PRを作ってください';
                } else if (issueContent.match(/調査|investigation|research|analyze|分析|確認/)) {
                  issueType = 'type:investigation';
                  requestMessage = '@claude この件について調査して、結果を簡潔にコメントしてください';
                } else if (issueContent.match(/リファクタリング|refactor|cleanup|整理|クリーンアップ/)) {
                  issueType = 'type:refactoring';
                  requestMessage = '@claude このリファクタリングを実施して、PRを作ってください';
                } else if (issueContent.match(/ドキュメント|document|readme|doc|docs|documentation/)) {
                  issueType = 'type:documentation';
                  requestMessage = '@claude ドキュメントを更新して、PRを作ってください';
                } else if (issueContent.match(/改善|enhance|improve|improvement|最適化|optimize/)) {
                  issueType = 'type:enhancement';
                  requestMessage = '@claude この改善の実装方針をまとめて、実装PRを作ってください';
                } else if (issueContent.match(/機能|feature|実装|implement|追加|add/)) {
                  issueType = 'type:feature';
                  requestMessage = '@claude この機能の実装方針をまとめて、実装PRを作ってください';
                }

                console.log(`Determined issue type: ${issueType}`);

                // Post a comment mentioning @claude with specific request
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unresolvedIssue.number,
                  body: requestMessage
                });

                // Add type label and claude-code-requested label
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unresolvedIssue.number,
                  labels: [issueType, 'claude-code-requested']
                });

                console.log(`Successfully commented on issue #${unresolvedIssue.number}, added ${issueType} and claude-code-requested labels`);
                return;
              }
            }

            console.log('No unresolved issues found with priority labels');
