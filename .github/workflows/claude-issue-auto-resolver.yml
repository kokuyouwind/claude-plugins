name: Claude Issue Auto-resolver

on:
  schedule:
    # JST 1:00~7:00 = UTC 16:00~22:00 (every hour)
    - cron: '0 16,17,18,19,20,21,22 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  resolve-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Find and comment on unresolved issue
        uses: actions/github-script@v8
        with:
          github-token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
          script: |
            // Search for issues in priority order: high -> medium -> low
            const priorities = ['priority:high', 'priority:medium', 'priority:low'];

            for (const priority of priorities) {
              console.log(`Searching for issues with label: ${priority}`);

              // Get all open issues with the priority label
              const { data: issues } = await github.rest.issues.listForRepo({
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: priority,
                state: 'open',
                sort: 'created',
                direction: 'desc'
              });

              // Find unresolved issues (without claude-code-requested label)
              const unresolvedIssue = issues.find(issue =>
                !issue.labels.some(label => label.name === 'claude-code-requested')
              );

              if (unresolvedIssue) {
                console.log(`Found issue #${unresolvedIssue.number} with ${priority}`);

                // Post a comment mentioning @claude
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unresolvedIssue.number,
                  body: '@claude この問題を解決してください'
                });

                // Add claude-code-requested label to prevent duplicate processing
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: unresolvedIssue.number,
                  labels: ['claude-code-requested']
                });

                console.log(`Successfully commented on issue #${unresolvedIssue.number} and added label`);
                return;
              }
            }

            console.log('No unresolved issues found with priority labels');
