name: Claude Issue Auto-resolver

on:
  schedule:
    # JST 1:00~7:00 = UTC 16:00~22:00 (every hour)
    - cron: '0 16,17,18,19,20,21,22 * * *'
  workflow_dispatch: # Allow manual triggering

jobs:
  resolve-issue:
    runs-on: ubuntu-latest
    permissions:
      issues: write
      contents: read
    steps:
      - name: Find and comment on unresolved issue
        env:
          # Use Personal Access Token as GitHub App tokens don't trigger claude-code-action
          GH_TOKEN: ${{ secrets.GITHUB_PAT }}
        run: |
          # Search for issues in priority order: high -> medium -> low
          for priority in "priority:high" "priority:medium" "priority:low"; do
            echo "Searching for issues with label: $priority"

            # Find unresolved issues (without claude-code-requested label)
            issue=$(gh issue list --repo ${{ github.repository }} \
              --label "$priority" \
              --state open \
              --json number,labels,createdAt \
              --jq '[.[] | select(.labels | map(.name) | contains(["claude-code-requested"]) | not)] | sort_by(.createdAt) | reverse | .[0].number')

            if [ -n "$issue" ] && [ "$issue" != "null" ]; then
              echo "Found issue #$issue with $priority"

              # Post a comment mentioning @claude
              gh issue comment $issue --repo ${{ github.repository }} \
                --body "@claude この問題を解決してください"

              # Add claude-code-requested label to prevent duplicate processing
              gh issue edit $issue --repo ${{ github.repository }} \
                --add-label "claude-code-requested"

              echo "Successfully commented on issue #$issue and added label"
              exit 0
            fi
          done

          echo "No unresolved issues found with priority labels"
